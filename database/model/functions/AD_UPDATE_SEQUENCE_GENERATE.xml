<?xml version="1.0"?>
  <database name="FUNCTION AD_UPDATE_SEQUENCE_GENERATE">
    <function name="AD_UPDATE_SEQUENCE_GENERATE" type="NULL">
      <body>/************************************************************************* 
* The contents of this file are subject to the Openbravo  Public  License 
* Version  1.0  (the  "License"),  being   the  Mozilla   Public  License 
* Version 1.1  with a permitted attribution clause; you may not  use this 
* file except in compliance with the License. You  may  obtain  a copy of 
* the License at http://www.openbravo.com/legal/license.html 
* Software distributed under the License  is  distributed  on  an "AS IS" 
* basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the 
* License for the specific  language  governing  rights  and  limitations 
* under the License. 
* The Original Code is Openbravo ERP. 
* The Initial Developer of the Original Code is Openbravo SL 
* All portions are Copyright (C) 2001-2006 Openbravo SL 
* All Rights Reserved. 
* Contributor(s):  ______________________________________. 
************************************************************************/ 
  v_StartWith VARCHAR(10) ; 
  v_StartWithSys VARCHAR(10) ; 
  TYPE RECORD IS REF CURSOR; 
    Cur_Tables RECORD; 
  BEGIN 
    SELECT TAD_LEVEL INTO v_StartWithSys  FROM AD_SYSTEM  WHERE AD_SYSTEM_ID=0; 
    v_StartWith:=TO_CHAR(TO_NUMBER(v_StartWithSys) +1) || '00000'; 
    v_StartWithSys:=v_StartWithSys || '00000'; 
    FOR Cur_Tables IN 
      (SELECT C.COLUMNNAME, 
        UPPER(T.TABLENAME) AS NAME 
      FROM AD_COLUMN C, 
        AD_TABLE T 
      WHERE C.AD_TABLE_ID=T.AD_TABLE_ID 
        AND UPPER(C.COLUMNNAME)=UPPER(T.TABLENAME) || '_ID' 
      ORDER BY T.TABLENAME 
      ) 
    LOOP 
      INSERT 
      INTO AD_SCRIPT_SQL VALUES 
        ( 
          (SELECT COALESCE(MAX(SEQNO), 0) +1 
          FROM AD_SCRIPT_SQL 
          ) 
          , 
           'UPDATE AD_SEQUENCE SET CURRENTNEXT=(SELECT AD_SEQUENCE.INCREMENTNO + ' ||  'COALESCE((SELECT MAX(t.' || Cur_Tables.NAME || '_ID) FROM ' || Cur_Tables.NAME || 
           ' t WHERE t.' || Cur_Tables.NAME || '_ID&gt;=AD_SEQUENCE.STARTNO),' ||  'AD_SEQUENCE.STARTNO-AD_SEQUENCE.INCREMENTNO) AS SEQUENCE FROM AD_SEQUENCE WHERE UPPER(NAME) = '||''''||Cur_Tables.NAME||''''|| 
           ') WHERE UPPER(NAME) = '||''''||Cur_Tables.NAME||'''' 
        ) 
        ; 
      IF(UPPER(Cur_Tables.NAME) LIKE 'AD_%') THEN 
        INSERT 
        INTO AD_SCRIPT_SQL VALUES 
          ( 
            (SELECT COALESCE(MAX(SEQNO), 0) +1 
            FROM AD_SCRIPT_SQL 
            ) 
            , 
             'UPDATE AD_SEQUENCE SET CURRENTNEXTSYS=('|| 
       ' SELECT AD_SEQUENCE.INCREMENTNO + ( CASE SIGN(COALESCE((SELECT MAX(t.' || Cur_Tables.NAME ||'_ID) FROM '||Cur_Tables.NAME||' t ' || 
             ' WHERE t.' || Cur_Tables.NAME || '_ID&lt;' || v_StartWith ||'),0)-' || v_StartWithSys || ') WHEN  -1  THEN '||v_StartWithSys || '-AD_SEQUENCE.INCREMENTNO ELSE ' || '(SELECT MAX(t.' || Cur_Tables.NAME || 
             '_ID) FROM ' ||Cur_Tables.NAME||  ' t WHERE t.' ||Cur_Tables.NAME ||'_ID&lt;' || v_StartWith || ') END) AS SEQUENCE '||  ' FROM AD_SEQUENCE '||  ' WHERE UPPER(NAME) = ' || '''' || Cur_Tables.NAME || ''''||') '|| 
             ' WHERE UPPER(NAME) = ' ||''''|| Cur_Tables.NAME || '''' 
          ) 
          ; 
      ELSE 
        INSERT 
        INTO AD_SCRIPT_SQL VALUES 
          ( 
            (SELECT COALESCE(MAX(SEQNO), 0) +1 
            FROM AD_SCRIPT_SQL 
            ) 
            , 
             'UPDATE AD_SEQUENCE SET CURRENTNEXTSYS=(' ||  ' SELECT AD_SEQUENCE.INCREMENTNO + COALESCE((SELECT MAX(t.' || Cur_Tables.NAME || 
             '_ID) FROM ' || Cur_Tables.NAME ||' t WHERE t.' || Cur_Tables.NAME ||'_ID&lt;' || v_StartWith ||'),(' || v_StartWithSys || '-AD_SEQUENCE.INCREMENTNO))' || 
             ' FROM AD_SEQUENCE WHERE UPPER(NAME) = ' || '''' || Cur_Tables.NAME || ''''||')' ||  ' WHERE UPPER(NAME) = ' ||''''|| Cur_Tables.NAME || '''' 
          ) 
          ; 
      END IF; 
    END LOOP; 
END Ad_Update_Sequence_Generate

</body>
    </function>
  </database>
