<?xml version="1.0"?>
  <database name="FUNCTION AD_DEPENDENCIES_CREATE">
    <function name="AD_DEPENDENCIES_CREATE" type="NULL">
      <body><![CDATA[/*************************************************************************
 * The contents of this file are subject to the Openbravo  Public  License
 * Version  1.0  (the  "License"),  being   the  Mozilla   Public  License
 * Version 1.1  with a permitted attribution clause; you may not  use this
 * file except in compliance with the License. You  may  obtain  a copy of
 * the License at http://www.openbravo.com/legal/license.html
 * Software distributed under the License  is  distributed  on  an "AS IS"
 * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
 * License for the specific  language  governing  rights  and  limitations
 * under the License.
 * The Original Code is Openbravo ERP.
 * The Initial Developer of the Original Code is Openbravo SL
 * All portions are Copyright (C) 2001-2006 Openbravo SL
 * All Rights Reserved.
 * Contributor(s):  ______________________________________.
 ************************************************************************/
/*************************************************************************
 * Title: AD_Dependencies_Create
 * Description:
 *      Create AD_Dependencies
 ************************************************************************/
  --  Logistice
  v_ResultStr           VARCHAR2(2000):='';

BEGIN

  v_ResultStr:='Deleting old data';
  DELETE FROM AD_DEPENDENCIES;

  INSERT INTO AD_DEPENDENCIES
  SELECT UPPER(TABLENAME), UPPER(COLUMNNAME), UPPER(DEPENDS_ON_TABLENAME), UPPER(DEPENDS_ON_COLUMNNAME)
  FROM (
  --Table
  SELECT DISTINCT T1.TABLENAME, C1.COLUMNNAME,
  T2.TABLENAME AS DEPENDS_ON_TABLENAME, C2.COLUMNNAME AS DEPENDS_ON_COLUMNNAME
  FROM AD_TABLE T1,AD_COLUMN C1, AD_TABLE T2, AD_COLUMN C2, AD_REF_TABLE
  WHERE C1.AD_REFERENCE_ID = 18
  AND T1.AD_TABLE_ID = C1.AD_TABLE_ID
  AND C1.AD_REFERENCE_VALUE_ID = AD_REF_TABLE.AD_REFERENCE_ID
  AND AD_REF_TABLE.AD_TABLE_ID = T2.AD_TABLE_ID
  AND AD_REF_TABLE.AD_KEY = C2.AD_COLUMN_ID
  AND T1.ISVIEW = 'N'
  UNION
  --TableDir
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME,
  SUBSTR(AD_COLUMN.COLUMNNAME,1,LENGTH(AD_COLUMN.COLUMNNAME)-3) AS DEPENDS_ON_TABLENAME,
  AD_COLUMN.COLUMNNAME AS DEPENDS_ON_COLUMNNAME
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 19
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- C_Location: ID=162
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'C_Location', 'C_Location_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 21
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- C_ValidCombination: ID=176
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'C_ValidCombination', 'C_ValidCombination_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 25
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- AD_Color
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'AD_Color', 'AD_Color_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 27
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  --Search...
 SELECT T.TABLENAME, C.COLUMNNAME, T2.TABLENAME, C2.COLUMNNAME
 FROM AD_COLUMN C, AD_TABLE T, AD_REFERENCE R, AD_REF_SEARCH S, AD_TABLE T2, AD_COLUMN C2
  WHERE C.AD_REFERENCE_ID = 30
  AND C.AD_TABLE_ID = T.AD_TABLE_ID
  AND T.ISVIEW = 'N'
 AND R.AD_REFERENCE_ID = C.AD_REFERENCE_VALUE_ID
 AND R.VALIDATIONTYPE='S'
 AND S.AD_REFERENCE_ID = R.AD_REFERENCE_ID
 AND S.AD_TABLE_ID = T2.AD_TABLE_ID
 AND S.AD_COLUMN_ID = C2.AD_COLUMN_ID
 UNION
 SELECT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME,
  SUBSTR(REPLACE(REPLACE(AD_COLUMN.COLUMNNAME,'BOM',''),'Substitute','M_Product'),1,LENGTH(REPLACE(REPLACE(AD_COLUMN.COLUMNNAME,'BOM',''),'Substitute','M_Product'))-3),
  REPLACE(REPLACE(AD_COLUMN.COLUMNNAME,'BOM',''),'Substitute','M_Product')
  FROM AD_TABLE, AD_COLUMN
  WHERE AD_COLUMN.AD_REFERENCE_ID = 30
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
 AND NOT EXISTS(SELECT 1 FROM AD_REFERENCE R WHERE R.AD_REFERENCE_ID = AD_COLUMN.AD_REFERENCE_VALUE_ID AND
             R.VALIDATIONTYPE='S')
  UNION
  -- M_Locator:
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'M_Locator', 'M_Locator_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID IN (31,800013)
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- AD_Image
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'AD_Image', 'AD_Image_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 32
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- S_ResourceAssignment: ID=485
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'S_ResourceAssignment', 'S_ResourceAssignment_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 33
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- M_AttributeSetInstance: ID=559
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'M_AttributeSetInstance', 'M_AttributeSetInstance_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 35
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N'
  UNION
  -- M_Product Search
  SELECT DISTINCT AD_TABLE.TABLENAME, AD_COLUMN.COLUMNNAME, 'M_Product', 'M_Product_ID'
  FROM AD_COLUMN, AD_TABLE
  WHERE AD_COLUMN.AD_REFERENCE_ID = 800011
  AND AD_COLUMN.AD_TABLE_ID = AD_TABLE.AD_TABLE_ID
  AND AD_TABLE.ISVIEW = 'N') A
  WHERE UPPER(A.COLUMNNAME) NOT IN ('C_SETTLEMENT_GENERATE_ID', 'C_SETTLEMENT_CANCEL_ID')
  UNION
  -- C_PROJECT
  SELECT 'C_PROJECT', 'C_PROJECTTYPE_ID', 'C_PROJECTTYPE', 'C_PROJECTTYPE_ID' FROM DUAL
  UNION
  SELECT 'C_DEBT_PAYMENT','C_SETTLEMENT_GENERATE_ID','C_SETTLEMENT','C_SETTLEMENT_ID' FROM DUAL
  UNION
  SELECT 'C_DEBT_PAYMENT','C_SETTLEMENT_CANCEL_ID','C_SETTLEMENT','C_SETTLEMENT_ID' FROM DUAL;


  -- Update sequence values
  v_ResultStr:='Updating sequences';

END AD_Dependencies_Create


]]></body>
    </function>
  </database>
