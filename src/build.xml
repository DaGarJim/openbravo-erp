<?xml version="1.0" encoding="UTF-8" ?>
<!--
 *************************************************************************
 * The contents of this file are subject to the Openbravo Public License 
 * Version 1.1 (the "License"), being the Mozilla Public License 
 * version 1.1  with a permitted attribution clause ; you may not use 
 * this file except in compliance with the License. 
 * You may obtain a copy of the License at  
 * http://www.openbravo.com/legal/license.txt 
 * Software distributed under the License is distributed on an 
 * "AS IS" basis, WITHOUT WARRANTY OF  ANY KIND, either express or 
 * implied. See the License for the specific language governing rights 
 * and  limitations under the License. 
 * The Original Code is Openbravo ERP. 
 * The Initial Developer of the Original Code is [Autores] and Openbravo SL 
 * All portions are Copyright (C) 2005-2006 Openbravo SL 
 * All Rights Reserved. 
 * Contributor(s): Openbravo S.L.
 ************************************************************************
-->

<!--
List of methods inside:

init: creates all the folders.
trl.clean: clean the AD_TEXTINTERFACES table
clean: delete all folders.
copy.srcClient: copy the content of the srcClient to the src folder.
sqlc: generates the java from the xsql files.
compileSqlc: compiles all the java generated from the xsqls.
wad: generates all the files from the mda.
postwad: copies the generated files to the base design folder.
postsrc: copies the src files to the base design folder and the 
         xml and jasper files to the translated designs folders
build.local.context: copies all files to the eclipse base context 
                     (WebContent...).
compile.src: comiles only the src files.
eclipse.compile: generates specified wad files and compiles modified xsql files.
eclipse.compile.complete: generates all wad files and compiles all xsql files
compile: compiles specified WAD window and src and also translates.
compile.complete: compiles all WAD windows and src and also translates.
translate: Translate the modified files.
compile.translate: Translate the specified extensions files.
installWebService: install the web services configuration file.
uninstallWebService: uninstall the web services configuration file.
copy.files: copy the local files to the context.
compile.development: like compile, but also copies the files to the context.
compile.complete.development: like compile.complete, but also copies the files 
                              to the context.
build.war: build a war file in the lib directory.
-->

<project name="openbravo sources" default="compile" basedir=".">
  <property name="webTab" value="all"/>
  <property name="tab" value="%"/>
  <property name="base.language" value="${base.source}/src"/>
  <property name="base.translate.structure" value="org/openbravo/erpWindows"/>
  <property name="client.web.xml" value="${base.client.src}/web.xml"/>
  <property name="package" value="/org"/>
  <property name="extension" value="html"/>
  <property name="src" value="."/>
  <property name="tr" value="yes"/>
  <condition property="translation">
    <not> 
      <equals arg1="no" arg2="${tr}"/>
    </not>
  </condition>
  <target name="init">
    <mkdir dir="${build}"/>
    <mkdir dir="${base.design}/design"/>
    <mkdir dir="${build.sqlc}"/>
    <mkdir dir="${build.sqlc}/src"/>
    <mkdir dir="${build.sqlc}/srcAD"/>
    <mkdir dir="${build.AD}"/>
    <mkdir dir="${build.AD}/org/openbravo/erpWindows"/>
    <mkdir dir="${build.AD}/org/openbravo/erpCommon/ad_actionButton"/>
    <mkdir dir="${build.AD}/org/openbravo/erpCommon/ad_callouts"/>
    <mkdir dir="${build.AD}/org/openbravo/erpCommon/reference"/>
    <mkdir dir="${build.docs}"/>
  </target>

  <target name="trl.clean" if="translation">
    <java classname="org.openbravo.translate.Translate" jvm="${env.JAVA_HOME}/bin/java" fork="yes" maxmemory="${build.maxmemory}">
      <arg line="clean ${base.config}/Openbravo.properties"/>
      <classpath refid="project.class.path"/>
    </java>
  </target>
  
  <target name="clean" depends="trl.clean">
    <property name="complete" value="true"/>
    <delete includeEmptyDirs="true" failonerror="false">
      <fileset dir="${base.design}"/>
      <fileset dir="${build}"/>
      <fileset dir="${build.docs}"/>
      <fileset dir="${build.AD}"/>
      <fileset dir="${build.sqlc}"/>
    </delete>
    <basename property="attach.path.filename" file="${attach.path}"/>
    <condition property="attach.path.condition" value="**/${attach.path.filename}/**" else="">
      <and>
        <contains string="${attach.path}" substring="${jakarta.context}" casesensitive="false"/>
      </and>
    </condition>
    <delete includeEmptyDirs="true" failonerror="false">
      <fileset dir="${jakarta.context}">
        <exclude name="${attach.path.condition}"/>
      </fileset>
    </delete>

  </target>

  <target name="copy.srcClient">
    <mkdir dir="${base.client.src}"/>
    <copy todir="${basedir}" overwrite="true" failonerror="false">
      <fileset dir="${base.client.src}">
        <exclude name="**/web.xml"/>
      </fileset>
    </copy>
  </target>

  <target name="sqlc" depends="copy.srcClient">
    <java classname="org.openbravo.data.Sqlc" fork="yes" jvm="${env.JAVA_HOME}/bin/java" maxmemory="${build.maxmemory}">
      <arg line="${base.config}/Openbravo.properties .xsql . ${build.sqlc}/src"/>
      <classpath refid="project.class.path"/>
    </java>
    <copy file="${base.source}/src/buildAD.xml" tofile="${base.source}/srcAD/build.xml"/>
    <copy file="${base.source}/src/log4j.lcf" tofile="${base.source}/srcAD/log4j.lcf"/>
    <ant dir="${base.source}/srcAD" target="buildAD" inheritAll="true" inheritRefs="true"/>
  </target>

  <target name="compileSqlc" depends="sqlc">
    <javac srcdir="${build.sqlc}/src:${basedir}:${build.sqlc}/srcAD/org/openbravo/erpCommon/reference" destdir="${build}" encoding="UTF-8" fork="true" memorymaximumsize="${build.maxmemory}" debug="${debug.level}" deprecation="on">
      <classpath refid="project.class.path"/>
    </javac>
    <javac srcdir="${build.sqlc}/srcAD" destdir="${build}" encoding="UTF-8" fork="true" memorymaximumsize="${build.maxmemory}" debug="${debug.level}" deprecation="on">
      <classpath refid="project.class.path"/>
    </javac>
    <javac srcdir="${build.AD}" destdir="${build}" encoding="UTF-8" fork="true" memorymaximumsize="${build.maxmemory}" debug="${debug.level}" deprecation="on">
      <classpath refid="project.class.path"/>
    </javac>
  </target>

  <target name="wad" depends="init">
    <java classname="org.openbravo.wad.Wad" jvm="${env.JAVA_HOME}/bin/java" fork="yes" maxmemory="${build.maxmemory}">
      <arg line="'${base.config}' '${tab}' '${build.AD}/org/openbravo/erpWindows' '${build.AD}/org/openbravo/erpCommon' '${build.sqlc}/src' '${webTab}' '${build.AD}/org/openbravo/erpCommon/ad_actionButton' '${base.design}' '${base.translate.structure}' '${client.web.xml}' '${base.source}' '${attach.path}' '${web.url}' '${base.src}' '${complete}'"/>
      <classpath refid="project.class.path"/>
    </java>
    <antcall target="postwad" inheritall="true" inheritrefs="true"/>
  </target>

  <target name="postwad">
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.xml"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.fo"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.html"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.srpt"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.jrxml"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${build.AD}" includes="**/*.jasper"/>
    </copy>
  </target>

  <target name="postsrc">
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.xml"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.fo"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.html"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.srpt"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.jrxml"/>
    </copy>
    <copy todir="${base.design}/design" >
      <fileset dir="${basedir}" includes="**/*.jasper"/>
    </copy>
    <java classname="org.openbravo.translate.CommandLine_CopyFiles" jvm="${env.JAVA_HOME}/bin/java" fork="yes" maxmemory="${build.maxmemory}">
      <arg line="'${base.config}/Openbravo.properties' '${basedir}' '${base.design}' '.xml' 'true' 'false'"/>
      <classpath refid="project.class.path"/>
    </java>
    <java classname="org.openbravo.translate.CommandLine_CopyFiles" jvm="${env.JAVA_HOME}/bin/java" fork="yes" maxmemory="${build.maxmemory}">
      <arg line="'${base.config}/Openbravo.properties' '${basedir}' '${base.design}' 'jasper' 'true' 'false'"/>
      <classpath refid="project.class.path"/>
    </java>
    <antcall target="build.local.context"/>
  </target>

  <target name="build.local.context">
    <copy todir="${base.context}"  encoding="UTF-8">
      <fileset file="${basedir}/index.html"/>
    </copy>
    <copy todir="${base.context}/WEB-INF"  encoding="UTF-8">
      <fileset file="${build.sqlc}/src/web.xml"/>
      <fileset dir="${base.config}"/>
    </copy>
    <copy todir="${base.context}/WEB-INF/lib"  encoding="UTF-8">
      <fileset dir="${base.lib}">
        <exclude name="openbravo-wad.jar"/>
        <exclude name="openbravo-trl.jar"/>
        <exclude name="*.war"/>
      </fileset>
    </copy>
    <mkdir dir="${base.context}/web"/>
    <copy todir="${base.context}/web"  encoding="UTF-8">
      <fileset dir="${base.source}/web/"/>
    </copy>
    <chmod dir="${base.context}" perm="775"/>
  </target>   

  <target name="compile.src" depends="compileSqlc, postsrc, copy.files">
  </target>

  <target name="eclipse.compile" depends="wad,sqlc, postsrc, translate">
  </target>

  <target name="eclipse.compile.complete" depends="clean,wad,sqlc, postsrc, translate">
  </target>

  <target name="compile" depends="wad,compileSqlc, postsrc, translate">
  </target>

  <target name="compile.complete" depends="clean,wad,compileSqlc,postsrc, translate">
  </target>

  <target name="translate" if="translation">
    <antcall inheritall="true" inheritrefs="true" target="compile.translate">
      <param name="extension" value="html"/>
    </antcall>
    <antcall inheritall="true" inheritrefs="true" target="compile.translate">
      <param name="extension" value="fo"/>
    </antcall>
    <antcall inheritall="true" inheritrefs="true" target="compile.translate">
      <param name="extension" value="srpt"/>
    </antcall>
    <antcall inheritall="true" inheritrefs="true" target="compile.translate">
      <param name="extension" value="jrxml"/>
    </antcall>
  </target>

  <target name="compile.translate">
    <java classname="org.openbravo.translate.Translate" jvm="${env.JAVA_HOME}/bin/java" fork="yes" maxmemory="${build.maxmemory}">
      <arg line="${base.config}/Openbravo.properties ${extension} ${basedir} ${base.design} ${package}"/>
      <classpath refid="project.class.path"/>
    </java>
  </target>

  <target name="installWebService" depends="init" if="wsdd">
    <java classname="org.apache.axis.client.AdminClient" fork="yes" jvm="${env.JAVA_HOME}/bin/java" maxmemory="${build.maxmemory}">
      <arg line="-l${context.url}/servlet/AxisServlet ${src}/deploy.wsdd"/>
      <classpath refid="project.class.path"/>
    </java>
  </target>

  <target name="uninstallWebService" depends="init">
    <java classname="org.apache.axis.client.AdminClient" fork="yes" jvm="${env.JAVA_HOME}/bin/java" maxmemory="${build.maxmemory}">
      <arg line="-l${context.url}/servlet/AxisServlet ${src}/undeploy.wsdd"/>
      <classpath refid="project.class.path"/>
    </java>
  </target>

  <target name="copy.files">
    <chmod dir="${build}" perm="755"/>
    <mkdir dir="${jakarta.base}/webapps/${context.name}"/>
    <copy todir="${jakarta.base}/webapps/${context.name}"  encoding="UTF-8">
      <fileset dir="${base.context}"/>
    </copy>
    <mkdir dir="${jakarta.base}/webapps/${context.name}/WEB-INF/classes"/>
    <copy todir="${jakarta.base}/webapps/${context.name}/WEB-INF/classes" encoding="UTF-8">
      <fileset dir="${build}"/>
    </copy> 
    <chmod dir="${jakarta.base}/webapps/${context.name}" perm="775"/>
  </target>

  <target name="compile.development" depends="compile, copy.files">
    <mkdir dir="${jakarta.base}/webapps/${context.name}/WEB-INF/lib"/>
    <copy todir="${jakarta.base}/webapps/${context.name}/WEB-INF/lib" file="${build.core.lib}/openbravo-core.jar" encoding="UTF-8">
    </copy>
  </target>

  <target name="compile.complete.development" depends="compile.complete, copy.files">
    <mkdir dir="${jakarta.base}/webapps/${context.name}/WEB-INF/lib"/>
    <copy todir="${jakarta.base}/webapps/${context.name}/WEB-INF/lib" file="${build.core.lib}/openbravo-core.jar" encoding="UTF-8">
    </copy>
  </target>

  <target name="build.war">
    <chmod dir="${build}" perm="755"/>
    <delete failonerror="false" file="${base.lib}/${context.name}.war"/>
    <war compress="true" destfile="${base.lib}/${context.name}.war" encoding="UTF-8" webxml="${base.context}/WEB-INF/web.xml">
      <zipfileset dir="${base.context}"/>
      <classes dir="${build}"/>
    </war>
  </target>
</project>
